<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Shop Admin - Manage your shop easily">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Shop Admin">
  
  <title>Shop Admin</title>
  
  <!-- Manifest for GitHub Pages -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    html, body { 
      height: 100%; 
      width: 100%;
      overflow: hidden; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      position: fixed;
    }
    
    iframe { 
      width: 100%; 
      height: 100%; 
      border: none; 
      display: block;
    }
    
    /* Loading screen */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    #loading.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loader {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #loading h2 {
      color: white;
      margin-top: 24px;
      font-weight: 600;
      font-size: 20px;
    }
    
    /* Install prompt - FIXED positioning */
    #install-prompt {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px 20px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 10000;
    }
    
    #install-prompt.show {
      transform: translateY(0);
    }
    
    .install-content {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    
    .install-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .install-text {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
      flex: 1;
      min-width: 0;
    }
    
    .install-buttons {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    #install-prompt button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      transition: background 0.2s;
    }
    
    #install-prompt button:active {
      background: #5568d3;
      transform: scale(0.98);
    }
    
    #install-prompt .close {
      background: #f3f4f6;
      color: #6b7280;
      padding: 10px 16px;
      min-width: auto;
    }
    
    #install-prompt .close:active {
      background: #e5e7eb;
      color: #374151;
    }
    
    @media (max-width: 480px) {
      #install-prompt {
        padding: 14px 16px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
      }
      
      .install-text {
        font-size: 13px;
      }
      
      #install-prompt button {
        padding: 8px 16px;
        font-size: 13px;
      }
      
      #install-prompt .close {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading">
    <div class="loader"></div>
    <h2>Loading Shop Admin...</h2>
  </div>
  
  <!-- Install prompt - FIXED -->
  <div id="install-prompt">
    <div class="install-content">
      <span class="install-icon">ðŸ“±</span>
      <span class="install-text">Install app for easier access</span>
    </div>
    <div class="install-buttons">
      <button id="install-btn">Install</button>
      <button class="close" id="close-prompt">âœ•</button>
    </div>
  </div>
  
  <!-- Main iframe -->
  <iframe 
    id="app-frame"
    src="https://script.google.com/macros/s/AKfycbxNvhn-i5s1sEakMKjIsbZK5ykoRYgEpqMoejpnHgUDNjSqpNR8LBKrkgn9FgVb0Os/exec" 
    allow="camera; geolocation"
    title="Shop Admin Application">
  </iframe>

  <script>
    // Service Worker Registration - Fixed for GitHub Pages
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Get the correct scope
        const scope = location.pathname.substring(0, location.pathname.lastIndexOf('/') + 1);
        
        navigator.serviceWorker.register('sw.js', { 
          scope: scope || '/'
        })
          .then(reg => {
            console.log('âœ… Service Worker registered:', reg.scope);
          })
          .catch(err => {
            console.log('âŒ Service Worker registration failed:', err);
          });
      });
    }

    // Hide loading screen when iframe loads
    const iframe = document.getElementById('app-frame');
    const loading = document.getElementById('loading');
    
    iframe.addEventListener('load', () => {
      setTimeout(() => {
        loading.classList.add('hidden');
      }, 500);
    });

    // PWA Install Prompt - IMPROVED
    let deferredPrompt;
    const installPrompt = document.getElementById('install-prompt');
    const installBtn = document.getElementById('install-btn');
    const closePrompt = document.getElementById('close-prompt');

    // Check if already installed
    function isInstalled() {
      // Check if running in standalone mode
      if (window.matchMedia('(display-mode: standalone)').matches) {
        return true;
      }
      // Check iOS standalone mode
      if (window.navigator.standalone === true) {
        return true;
      }
      return false;
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      console.log('âœ… Install prompt available');
      
      // Show install prompt after 2 seconds if not installed
      setTimeout(() => {
        if (!isInstalled() && !sessionStorage.getItem('installPromptDismissed')) {
          installPrompt.classList.add('show');
        }
      }, 2000);
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) {
        console.log('âŒ No install prompt available');
        return;
      }
      
      installPrompt.classList.remove('show');
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log(`User response: ${outcome}`);
      
      deferredPrompt = null;
    });

    closePrompt.addEventListener('click', () => {
      installPrompt.classList.remove('show');
      sessionStorage.setItem('installPromptDismissed', 'true');
    });

    // Handle successful installation
    window.addEventListener('appinstalled', () => {
      console.log('âœ… PWA installed successfully');
      installPrompt.classList.remove('show');
      deferredPrompt = null;
    });

    // Check on load
    if (isInstalled()) {
      console.log('âœ… App is already installed');
    }
  </script>
</body>
</html>
